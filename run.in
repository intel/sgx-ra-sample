#! /bin/bash

#----------------------------------------------------------------------------
# Get our program name
#----------------------------------------------------------------------------

PROG=`basename $0`


#----------------------------------------------------------------------------
# Environment setup.
#----------------------------------------------------------------------------

# Where is OpenSSL 1.1.x?

OPENSSL_LIBDIR=@OPENSSL_LIBDIR@
if [ "$OPENSSL_LIBDIR" = "" ]
then
	echo "Could not auto-detect openssl v1.1.0 or newer. Make sure LD_LIBRARY_PATH is set" >&2
else
	if [ "$LD_LIBRARY_PATH" = "" ]
	then
		export LD_LIBRARY_PATH=$OPENSSL_LIBDIR
	else
		export LD_LIBRARY_PATH=$OPENSSL_LIBDIR:$LD_LIBRARY_PATH
	fi
fi

# Do we need to add curl's libdir?

CURL_LIBDIR=@CURL_LIBDIR@
if [ "$CURL_LIBDIR" != "" ]
then
	if [ "$LD_LIBRARY_PATH" = "" ]
	then
		export LD_LIBRARY_PATH=$OPENSSL_LIBDIR
	else
		export LD_LIBRARY_PATH=$OPENSSL_LIBDIR:$LD_LIBRARY_PATH
	fi
fi

#----------------------------------------------------------------------------
# Parse our settings file
#----------------------------------------------------------------------------

source settings

# Optional settings

if [ "$QUERY_IAS_PRODUCTION" != "" -a "$QUERY_IAS_PRODUCTION" -ne 0 ]; then
	sp_production=-P
fi

if [ "$LINKABLE" != "" -a "$LINKABLE" -ne 0 ]; then
	flag_linkable=-l
fi

# Optional client settings

if [ "$RANDOM_NONCE" != "" -a "$RANDOM_NONCE" -ne 0 ]; then
	cl_nonce=-r
fi

if [ "$USE_PLATFORM_SERVICES" != "" -a "$USE_PLATFORM_SERVICES" -ne 0 ]; then
	cl_pse=-m
fi

# Optional service provider/server settings

if [ "$IAS_CLIENT_CERT_KEY_PASSWORD_FILE" != "" ]; then
	sp_cert_passwd="--ias-cert-passwd-file=$IAS_CLIENT_CERT_KEY_PASSWORD_FILE"
fi

if [ "$IAS_PROXY_URL" != "" ]; then
	sp_proxy="--proxy=$IAS_PROXY_URL"
fi

if [ "$IAS_DISABLE_PROXY" != "" -a "$IAS_DISABLE_PROXY" -ne 0 ]; then
	sp_noproxy="-x"
fi

# Debugging options

if [ "$VERBOSE" != "" -a "$VERBOSE" -ne 0 ]; then
	flag_verbose=-v
fi

if [ "$DEBUG" != "" -a "$DEBUG" -ne 0 ]; then
	flag_debug=-d
fi


#----------------------------------------------------------------------------
# Execute
#----------------------------------------------------------------------------

if [ "$PROG" = "run-client" ]
then
	./client \
		-s $SPID \
		$cl_nonce $cl_pse \
		$flag_linkable $flag_debug $flag_verbose \
		"$@"
elif [ "$PROG" = "run-server" ]
then
	./sp \
		-s $SPID "$@" \
		-A "$IAS_REPORT_SIGNING_CA_FILE" \
		-C "$IAS_CLIENT_CERT_FILE" \
		$sp_noproxy $sp_proxy $sp_cert_passwd \
		$flag_linkable $flag_debug $flag_verbose \
		"$@"
else
	echo "$PROG: unrecognized instance (expected run-client or run-server)" >&2
	exit 1
fi

